{% extends 'frontend/phone.html' %}
{% load static %}

{% block title %}지도{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/map.css' %}" />
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
        </style>
{% endblock %}

{% block content %}
    <div class="map">
        <form method="GET" action="{% url 'popplace:map' %}">
            <input type="text" name="query" placeholder="검색어를 입력하세요" value="{{ query }}">
            <label for="category">카테고리:</label>
            <select id="category" name="category">
                <option value="">전체</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
            <label for="location">지역:</label>
            <select id="location" name="location">
                <option value="">전체</option>
                {% for location in locations %}
                    <option value="{{ location.id }}" {% if location.id|stringformat:"s" == selected_location %}selected{% endif %}>{{ location.name }}</option>
                {% endfor %}
            </select>
            <label for="date">날짜:</label>
            <input type="date" id="date" name="date" value="{{ selected_date }}">
            <button type="submit">검색</button>
        </form>
        <div id="mapwrap">
            <div id="map"></div>
        </div>
    </div>
{% endblock %}

{% block nav %}
    {% include './nav/nav_map.html' %}
{% endblock %}

{% block js %}
    <!-- Kakao 지도 API 비동기로드 -->
    <script type="text/javascript">
        var map;
        var markers = [];
        var currentOverlay = null;  // 현재 표시된 오버레이를 저장할 변수

        var stores = [
            {% for store in stores %}
                {
                    id: {{ store.id }},
                    name: "{{ store.name }}",
                    image: "{{ store.image.url }}",  // 이미지 URL
                    description: "{{ store.description|safe }}",  // 설명
                    latitude: {{ store.latitude }},
                    longitude: {{ store.longitude }},
                    address: "{{ store.address }}",  // 지역 이름
                    popupstore_url: "{% url 'popplace:popupstore' store.id %}",
                },
            {% endfor %}
        ];

        document.addEventListener("DOMContentLoaded", function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=536649895a2fca9bfd027f79ac41c3aa&libraries=services&autoload=false';
            script.onload = function() {
                kakao.maps.load(function() {
                    initMap();
                });
            };
            document.head.appendChild(script);
        });

        function initMap() {
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 5
            };
            map = new kakao.maps.Map(container, options);
            addMarkers(stores);
            
            // 지도 클릭 시 현재 오버레이 숨기기
            kakao.maps.event.addListener(map, 'click', function() {
                hideCurrentOverlay();
            });
        }

        function addMarkers(filteredStores) {
            clearMarkers();
            filteredStores.forEach(function(store) {
                var markerPosition = new kakao.maps.LatLng(store.latitude, store.longitude);
                var marker = new kakao.maps.Marker({
                    position: markerPosition,
                    map: map
                });
                markers.push(marker);

                var content =
                    '<div class="overlayInfo">' +
                    '  <a href="' + store.popupstore_url + '" target="_blank">' +
                    '  <div class="infoImage" >' +
                    '    <img src="' + store.image + '" alt="' + store.name + '">' +
                    '  </div>' +
                    '  <div class="infoText">' +
                    '    <p>위치: ' + store.address + '</p>' +
                    '  </div>' +
                    '  </a>' +
                    '</div>';

                var overlay = new kakao.maps.CustomOverlay({
                    position: markerPosition,
                    content: content,
                    yAnchor: 1,
                    map: null,  // 초기에는 지도에 추가하지 않음
                    clickable: true  // 클릭 가능하도록 설정
                });

                // 마커를 클릭했을 때 오버레이 표시
                kakao.maps.event.addListener(marker, 'click', function() {
                    if (currentOverlay) {
                        currentOverlay.setMap(null);  // 현재 표시된 오버레이 숨기기
                    }
                    overlay.setMap(map);   // 새로운 오버레이 표시
                    currentOverlay = overlay;  // 현재 표시된 오버레이 업데이트
                });
            });
        }

        function clearMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            currentOverlay = null;
        }

        function hideCurrentOverlay() {
            if (currentOverlay) {
                currentOverlay.setMap(null);
                currentOverlay = null;
            }
        }

    </script>
{% endblock %}
