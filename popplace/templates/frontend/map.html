{% extends 'frontend/phone.html' %}
{% load static %}

{% block title %}지도{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/map.css' %}" />
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="map">
        <form method="GET" action="{% url 'popplace:map' %}">
            <input type="text" name="query" placeholder="검색어를 입력하세요" value="{{ query }}">
            <label for="category">카테고리:</label>
            <select id="category" name="category">
                <option value="">전체</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
            </select>
            <label for="location">지역:</label>
            <select id="location" name="location">
                <option value="">전체</option>
                {% for location in locations %}
                    <option value="{{ location.id }}" {% if location.id|stringformat:"s" == selected_location %}selected{% endif %}>{{ location.name }}</option>
                {% endfor %}
            </select>
            <label for="date">날짜:</label>
            <input type="date" id="date" name="date" value="{{ selected_date }}">
            <button type="submit">검색</button>
            <button type="button" onclick="resetFilters()">전체 보기</button>
        </form>
        <div id="mapwrap">
            <div id="map"></div>
        </div>
    </div>
{% endblock %}

{% block nav %}
    {% include './nav/nav_map.html' %}
{% endblock %}

{% block js %}
    <!-- Kakao 지도 API 비동기로드 -->
    <script type="text/javascript">
        var map;
        var markers = [];
        var overlays = [];
        var stores = [
            {% for store in stores %}
                {
                    id: {{ store.id }},
                    name: "{{ store.name }}",
                    latitude: {{ store.latitude }},
                    longitude: {{ store.longitude }},
                    category_name: "{{ store.category_name }}",  // 카테고리 이름
                    location_name: "{{ store.location_name }}",  // 지역 이름
                    start_date: "{{ store.start_date }}",
                    end_date: "{{ store.end_date }}"
                },
            {% endfor %}
        ];

        document.addEventListener("DOMContentLoaded", function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=536649895a2fca9bfd027f79ac41c3aa&libraries=services&autoload=false';
            script.onload = function() {
                kakao.maps.load(function() {
                    initMap();
                });
            };
            document.head.appendChild(script);
        });

        function initMap() {
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 5
            };
            map = new kakao.maps.Map(container, options);
            addMarkers(stores);
        }

        function addMarkers(filteredStores) {
            clearMarkers();
            filteredStores.forEach(function(store) {
                var markerPosition = new kakao.maps.LatLng(store.latitude, store.longitude);
                var marker = new kakao.maps.Marker({
                    position: markerPosition
                });
                marker.setMap(map);
                markers.push(marker);

                var overlayContent = '<div class="customoverlay">' +
                    '  <a href="https://map.kakao.com/link/map/' + store.name + "," + store.latitude + "," + store.longitude + '" target="_blank">' +
                    '    <span class="title">' + store.name + "</span>" +
                    "  </a>" +
                    "  <br>카테고리: " + store.category_name +
                    "  <br>위치: " + store.location_name +
                    "</div>";
                var overlay = new kakao.maps.CustomOverlay({
                    position: markerPosition,
                    content: overlayContent,
                    yAnchor: 1,
                    map: map
                });
                overlays.push(overlay);

                kakao.maps.event.addListener(marker, 'click', function() {
                    hideOverlays();
                    overlay.setMap(map);
                });
            });
        }

        function clearMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
            overlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
            overlays = [];
        }

        function hideOverlays() {
            overlays.forEach(function(overlay) {
                overlay.setMap(null);
            });
        }

        function resetFilters() {
            window.location.href = "{% url 'popplace:map' %}";
        }
    </script>
{% endblock %}
