{% extends 'frontend/phone.html' %}
{% load static %}

{% block title %}지도{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/map.css' %}" />
    <style>
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="map">
        {% include './searchBar.html' %}
        <div id="mapwrap">
            <div id="map"></div>
            <!-- 카테고리 섹션은 임시로 제거 -->
        </div>
    </div>
{% endblock %}

{% block nav %}
    {% include './nav/nav_map.html' %}
{% endblock %}

{% block js %}
    <!-- Kakao 지도 API 비동기로드 -->
    <script type="text/javascript">
        function initMap() {
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // 지도의 중심 좌표 설정
                level: 5 // 지도의 확대 레벨 설정
            };
            var map = new kakao.maps.Map(container, options); // 지도 생성 및 객체 리턴

            // Django 템플릿에서 직접 데이터를 JavaScript 변수로 넣기
            var stores = [
                {% for store in stores %}
                    {
                        id: {{ store.id }},
                        name: "{{ store.name }}",
                        latitude: {{ store.latitude }},
                        longitude: {{ store.longitude }}
                    },
                {% endfor %}
            ];

            console.log(stores); // 데이터가 제대로 반영되었는지 콘솔에서 확인

            // 마커 데이터 가져오기
            stores.forEach(store => {
                var markerPosition = new kakao.maps.LatLng(store.latitude, store.longitude); 
                var marker = new kakao.maps.Marker({
                    position: markerPosition
                });
                marker.setMap(map);

                // 커스텀 오버레이 생성
                var overlayContent =
                    '<div class="customoverlay">' +
                    '  <a href="https://map.kakao.com/link/map/' +
                    store.name +
                    "," +
                    store.latitude +
                    "," +
                    store.longitude +
                    '" target="_blank">' +
                    '    <span class="title">' +
                    store.name +
                    "</span>" +
                    "  </a>" +
                    "</div>";
                var overlay = new kakao.maps.CustomOverlay({
                    position: markerPosition,
                    content: overlayContent,
                    yAnchor: 1,
                    map: map // 초기에는 지도에 추가
                });

                // 마커에 클릭 이벤트 추가
                kakao.maps.event.addListener(marker, 'click', function() {
                    overlay.setMap(map);
                });
            });

            // 마커 카테고리 변경 함수
            window.changeMarker = function(type) {
                // 마커를 카테고리에 따라 필터링하는 로직 추가
            };
        }

        // Kakao 지도 API 스크립트 비동기 로드
        (function() {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = '//dapi.kakao.com/v2/maps/sdk.js?appkey=536649895a2fca9bfd027f79ac41c3aa&libraries=services&autoload=false';
            script.onload = function() {
                kakao.maps.load(function() {
                    initMap();
                });
            };
            document.head.appendChild(script);
        })();
    </script>
{% endblock %}
